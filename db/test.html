<!doctype html>
<html>
<!--Simple Read eval print loop for SQL-->

<head>
	<meta charset="utf8">
	<title>SQL TEST</title>
	<script src="./sql.js"></script>
</head>

<body>
	
	<button id='submit'>Execute</button>
	<pre id='result'></pre>
	<pre id='error'></pre>
	<pre id="output">Results will be displayed here</pre>
	<ul id ="listado"></ul>
	
	<script>
var outputElm = document.getElementById('output');
// Create an HTML table
var tableCreate = function () {
	function valconcat(vals, tagName) {
		if (vals.length === 0) return '';
		var open = '<' + tagName + '>', close = '</' + tagName + '>';
		return open + vals.join(close + open) + close;
	}
	return function (columns, values) {
		var tbl = document.createElement('table');
		var html = '<thead>' + valconcat(columns, 'th') + '</thead>';
		var rows = values.map(function (v) { return valconcat(v, 'td'); });
		html += '<tbody>' + valconcat(rows, 'tr') + '</tbody>';
		tbl.innerHTML = html;
		return tbl;
	}
}();


		
document.getElementById('submit').onclick = function () {
				
    function loadBinaryFile(path,success) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", path, true); 
        xhr.responseType = "arraybuffer";
        xhr.onload = function() {
            var data = new Uint8Array(xhr.response);
            var arr = new Array();
            for(var i = 0; i != data.length; ++i) arr[i] = String.fromCharCode(data[i]);
            success(arr.join(""));
        };
        xhr.send();
    };
    

    loadBinaryFile('./siguaLite.db', function(data){
        var db = new SQL.Database(data);
        // Database is ready
        var sql ="SELECT d.cod_dpto_sigua AS codigo, d.txt_dpto_sigua AS nombre, count( d.txt_dpto_sigua) AS cuenta FROM departamentos d INNER JOIN estancias e ON d.cod_dpto_sigua = e.dpto WHERE e.codigo != '0000PB997' AND d.cod_dpto_sigua !='07.018' GROUP BY  d.cod_dpto_sigua ,d.txt_dpto_sigua LIMIT 10";    
        var results = db.exec(sql);
        // output en una tabla
        outputElm.innerHTML = "";
		for (var i = 0; i < results.length; i++) {
			outputElm.appendChild(tableCreate(results[i].columns, results[i].values));
		}
        
        
        //var row = results.getAsObject();
        //console.log('Here is a row: ' + JSON.stringify(row));
        
        
        
        
        
        
        
        
        //document.getElementById('result').innerHTML = JSON.stringify(res, null, '  ');
        
        
        
      ///*  
      // Prepare a statement
      var results = db.prepare("SELECT * FROM actividades WHERE codactividad BETWEEN $start AND $end");
      results.getAsObject({$start:1, $end:1}); // {col1:1, col2:111}
  
      // Bind new values
      results.bind({$start:1, $end:20});
      while(results.step()) { //
        var row = results.getAsObject();
        console.log('Here is a row: ' + JSON.stringify(row));
      }
      
 //alert (results.step() );
	  var unaLista = "";
      while(results.step()) { //
        var row = results.getAsObject();
        //console.log('Here is a row: ' + JSON.stringify(row));
        unaLista += "<li>"+row.txt_actividad+"</li>";
      }
      $('#listado').append(unaLista);
 
 
   /*   
            var len = results.length;
            //showMessage('Total registros: ' +len);
            
            $('#listado').empty();
            for (var i = 0; i < len; i++) {
                var unaLista= "<li>"+results.rows.item(i).codigo+"</li>";
                // var unaLista= "<li id='EstDptoId€"+results.rows.item(i).codigo+"' >"+results.rows.item(i).codigo + " - " + results.rows.item(i).nombre+" <span class='w3-badge w3-right w3-margin-right'>"+results.rows.item(i).cuenta+"</span>    </li>";

                $('#listado').append(unaLista);
            }      
      */
	      
      
      
      
      
      
      
      
      //*/  
        
        
     /* 		var len = res.rows.length;
        alert('Total registros: ' +len);
      
        $('#listado').empty();
            for (var i = 0; i < len; i++) {
                var unaLista= "<li id='EstCard€"+results.rows.item(i).codigo+"'>"+results.rows.item(i).codigo + " - " + results.rows.item(i).actividad+"</li>";
                //var unaLista= "<li id='estCard€"+results.rows.item(i).codigo+"€"+results.rows.item(i).lon+"€"+results.rows.item(i).lat+"'>"+results.rows.item(i).codigo + " - " + results.rows.item(i).nombre+"</li>";
                $('#listado').append(unaLista);
        }*/		





    });		
};
		



	</script>
	<script src='deps/jquery-3.3.1.min.js'></script>
</body>
